---
# Custom instructions for GitLab Duo Code Review
# Based on GitLab's official code review guidelines

# References:
# - Code Review Guidelines: https://docs.gitlab.com/development/code_review/
# - Database Review Guidelines: https://docs.gitlab.com/development/database_review/
# - Developer Guide: https://docs.gitlab.com/operator/developer/guide/
# - Contributing Guide: https://docs.gitlab.com/development/contributing/
# - Documentation Guide: https://docs.gitlab.com/development/documentation/styleguide/
# - Field Standardisation in Observability: https://handbook.gitlab.com/handbook/engineering/architecture/design-documents/observability_field_standardisation/


# This file defines custom review criteria that will be applied to specific files
# during merge request reviews. Instructions are grouped by name and can target
# multiple file patterns using glob syntax.
instructions:
  - name: General Standards
    fileFilters:
      - "**/*"
    instructions: |
      1. Ensure you use inclusive language where applicable, e.g. prefer `allowlist` over `whitelist`
      2. Verify CE/EE code separation:
         - Code in CE (outside `ee/` directory) should not directly reference EE modules or classes
         - EE extensions should use `prepend_mod` pattern in CE files
         - If CE code needs EE-aware behavior, use `prepend_mod` hooks or `Gitlab.ee?` guards
         - Flag direct references to `EE::` namespaced classes in CE code
         - This prevents FOSS build failures
         - Reference: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/development/ee_features.md
  - name: Ruby Code Quality
    fileFilters:
      - "**/*.rb"
      - "!spec/**/*"
    instructions: |
      1. Check for N+1 queries - ensure use of `includes()`, `preload()`, or `eager_load()` when accessing associations
      2. Ensure `update_all`, `delete_all`, `destroy_all` have proper conditions
      3. Ensure authorization checks in controller actions and API endpoints
      4. Ensure input validation for user-provided parameters
      5. Ensure no information disclosure in error responses
      6. Ensure all modified or new queries are flagged as needing a database reviewer
      7. Ensure all ActiveRecord scope changes (new scopes, modified scopes, or scope deletions) are flagged as needing a database reviewer
      8. For ActiveRecord scope changes, verify:
         - The scope includes appropriate indexes for filtered columns
         - The scope avoids expensive operations like subqueries on large tables
         - Default scopes are avoided unless absolutely necessary (they can cause unexpected query behavior)
      9. Ensure all modified or new queries have both raw SQL and query plans documented in the merge request description
      10. Analyze query plans for common pitfalls in the merge request description:
        - Sequential scans on large tables
        - Nested loops with large datasets
        - Missing or inefficient index usage
        - High-cost operations
        - Unexpected sort operations
        - Verify the query returns expected records (not zero rows)
        - Check that maximum query execution time is under 100ms
        - Ensure the query plan reflects the complete query as executed by the database, including all chained scopes, pagination, ordering, and any other modifiers - not a partial or simplified version of the query
      11. Flag comments that only describe what code does (e.g., "# Loop through users") rather than why. Suggest removing these comments and using better naming or method extraction instead
      12. For ActiveRecord callbacks (before_validation, before_save, after_save, etc.):
          - Verify callbacks only modify data on the current model, not associated records
          - Question if callback logic should be in a service layer instead
          - Ask: "Why use this callback instead of explicit method calls in the service/controller?"
          - Flag callbacks that have side effects (external API calls, updating other records, complex business logic)
          - Flag bulk operations on associated records in callbacks (performance concern as associations grow)
          - Acceptable uses: data normalization on current model only (trimming whitespace, setting defaults)
          - Reference: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/development/backend/ruby_style_guide.md#avoid-activerecord-callbacks

  - name: Database Migrations
    fileFilters:
      - "db/migrate/**/*.rb"
      - "db/post_migrate/**/*.rb"
      - "ee/db/geo/migrate/**/*.rb"
      - "lib/gitlab/background_migration/**/*.rb"
    instructions: |
      1. Ensure migrations are reversible (add explicit down method for complex operations)
      2. Ensure bulk operations use batched migrations
      3. Use post-migrations for time-consuming operations
      5. Ensure column removals were ignored in previous release
      7. Ask: "Have you triggered the db:gitlabcom-database-testing pipeline?"
      8. For migrations that modify the database schema:
         - Ensure db/structure.sql is updated to reflect the changes
      9. For creating new tables, views or dropping existing tables/views:
          - Ensure the Database Dictionary is updated to reflect the changes
          - Remind: "When creating tables/views or dropping tables/views, make sure to update the Database Dictionary to maintain accurate documentation of the database schema"
      10. For column additions with foreign keys to pre-existing tables (not created in the current merge request):
         - Check if an index exists or is being added for the foreign key column
         - Ask: "What is the current size of this table, and what is the projected size after adding this column? Tables cannot exceed 50 GB total size (including all indexes and column data) after adding a new column with a foreign key on GitLab.com."
         - Remind: "If this table exceeds or will exceed the size limit, you can request an exemption by filing an issue with the Database Frameworks Team: https://docs.gitlab.com/development/database/large_tables_limitations/#requesting-an-exception"
         - Ask: "Are you following the guidelines for adding foreign keys to existing tables to avoid downtime and migration failures? See: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/development/database/foreign_keys.md#avoiding-downtime-and-migration-failures"
      11. For column additions without foreign keys to pre-existing tables (not created in the current merge request):
          - Ask: "What is the current size of this table, and what is the projected size after adding this column? Tables cannot exceed 100 GB total size (including all indexes and column data) after adding a new column on GitLab.com."
          - Remind: "If this table exceeds or will exceed the size limit, you can request an exemption by filing an issue with the Database Frameworks Team: https://docs.gitlab.com/development/database/large_tables_limitations/#requesting-an-exception"
      12. For new tables created in the current merge request that contain foreign key columns:
          - Ensure indexes are created for all foreign key columns
          - Check if each foreign key column in this new table has a corresponding index
      13. For new tables created in the current merge request:
          - Check if columns are ordered optimally for space efficiency:
            - Group fixed-width columns together in descending size order (8-byte types first, then 4-byte, etc.)
            - Place variable-width columns (text, varchar, arrays, json, jsonb) at the end
          - Ask: "Have you ordered the columns to minimize space usage by grouping fixed-width columns together and placing variable-width columns at the end?"
          - Remind: "Proper column ordering can significantly reduce storage requirements at scale. See: https://docs.gitlab.com/development/database/ordering_table_columns/"
      14. For migrations that drop or replace an index:
          - Remind: "Before removing an index, verify queries can use other existing indexes efficiently. Confirm the index is unused on GitLab.com and Self-Managed."
          - Suggest: "For investigating index usage you can start by gathering all the metadata available for the index. For GitLab.com, you can view index usage data in [Grafana](https://dashboards.gitlab.net/goto/TsYVxcBHR?orgId=1)"
          - Ask: "Are you following the guidelines for dropping unused indexes? See: https://docs.gitlab.com/development/database/adding_database_indexes/#dropping-unused-indexes"

  - name: Test Coverage
    fileFilters:
      - "spec/**/*_spec.rb"
      - "ee/spec/**/*_spec.rb"
      - "!spec/factories/**/*"
      - "!spec/support/**/*"
    instructions: |
      1. Use shared examples to reduce duplication
      2. Ensure error handling tests for security-sensitive operations
      3. Ensure input validation tests for user-facing endpoints
      4. For conditional logic (||, &&, if/else, case), verify each branch has test coverage
      5. For helper methods, ensure unit specs exist (not just integration coverage)
      6. For callbacks (before_validation, before_save), ensure unit specs test the callback behavior specifically
      7. Flag missing edge case coverage:
         - Nil/empty values
         - Boundary conditions
         - Fallback logic (|| operators)
         - Error states
      8. Follow the testing pyramid: most tests at unit level, fewer at integration/system level
      9. Reference: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/development/testing_guide/testing_levels.md

  - name: Documentation
    fileFilters:
      - "doc/**/*.md"
    instructions: |
      1. Ensure new or updated content aligns with existing content in technical meaning and style.
      2. Ensure the style is clear, concise, and not repetitive.
      3. Use American English spelling and active voice.
      4. Avoid excessive or repetitive links.
      5. Avoid ambiguous phrases and be consistent with feature names.
      6. Focus on the features and benefits GitLab brings to customers, rather than what GitLab has created.
      7. Avoid sales or marketing language, including words like "easily" or "simply."
      8. Avoid writing about the document itself. Get straight to the point instead of using phrases like "This page shows."
      9. Tend toward lowercase, use sentence case for topic titles, and match UI text capitalization.
      10. Use bold for UI elements only.
      11. Use sentence case for table headers.
      12. When describing the location of a UI element, use the location first, then action the user must take.
      13. When linking to GitLab issues, include the GitLab issue number in the link text.
      14. Start optional steps with "Optional."
      15. Resize wide or tall screenshots. Compress size on disk to 100 KB or less. Use descriptive lowercase filenames with underscores instead of hyphens. Filenames should include the major and minor version of GitLab in the format "_v18_6".
      16. Avoid using blockquotes.
      17. Do not promise work in future milestones. Instead, say work is being proposed.
      18. Along with the previous instructions, documentation should follow:
          - The GitLab Documentation style guide: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/development/documentation/styleguide/_index.md
          - The GitLab Documentation recommended word list: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/development/documentation/styleguide/word_list.md
          - GitLab Flavored Markdown syntax standards: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/user/markdown.md

  - name: API documentation
    fileFilters:
      - "doc/api/**/*.md"
    instructions: |
      1. Every method must include the REST API request with HTTP method (GET, PUT, DELETE) followed by the request path starting with '/'.
      2. Every method must have a detailed description of attributes in a table format, with required attributes listed first, then sorted alphabetically.
      3. Every method must include a cURL example using https://gitlab.example.com/api/v4/ as the endpoint and <your_access_token> as the token placeholder.
      4. Every method must have a detailed description of the response body and a JSON response example.
      5. If endpoints attributes are available only to higher subscription tiers or specific offerings, include this information in the attribute description.
      6. For complex object types, represent sub-attributes with dots, like 'project.name' or 'projects[].name' for arrays.
      7. For curl commands, use long option names ('--header' instead of '-H'), declare URLs with the '--url' parameter in double quotes, and use line breaks with '\' for readability.
      8. Along with the previous instructions, API documentation should follow the GitLab "Documenting REST API resources" guidelines: https://gitlab.com/gitlab-org/gitlab/-/blob/master/doc/development/documentation/restful_api_styleguide.md

  - name: Localization template files
    fileFilters:
      - "locale/gitlab.pot"
    instructions: |
      1. Flag any msgid entry that starts with a lowercase letter - this indicates a split sentence that will be hard to translate

  - name: Experiments
    fileFilters:
      - "**/*.rb"
      - "**/*.js"
      - "**/*.vue"
    instructions: |
      For experiment-related changes, verify:
      1. Experiment uses an `experiment` type feature flag (not `development` or `ops`)
      2. Context is appropriate and consistent (e.g., `actor:`, `project:`, `group:`)
      3. Variants are clearly defined (control, candidate, or named variants)
      4. If corresponding issue mentions tracking beyond default assignment tracking, there are tracking calls like `experiment(:name, actor: current_user).track(:event_name)`
      5. Same context is used between experiment runs and tracking calls
      6. If experiment uses only `experiment(:name, actor: current_user)` as context, but the corresponding issue mentions tracking of namespace based activation events, then assignment should happen based on namespace or actor + namespace
      7. If experiment is first assigned during registration via `experiment(:name, actor: current_user)` before a namespace is created, there should be another assignment tracking event invoked like this `experiment(:name, actor: current_user).track(:assignment, namespace: group)` to enable tracking of activation events
      8. Frontend or feature tests exist to prevent premature code removal (see [testing levels](https://docs.gitlab.com/development/testing_guide/testing_levels/#white-box-tests-at-the-system-level-formerly-known-as-system--feature-tests))
      9. Tests cover experiment variants and tracking behavior
      10. Temporary assets (icons/illustrations) are in `/ee/app/assets/images` or `/app/assets/images` not Pajamas library
      11. When both control and variants are being toggled in Vue components layer, we prefer to use the `<gitlab-experiment>` component.

  - name: Schema Migrations
    fileFilters:
      - "db/schema_migrations/**/*"
    instructions: |
      1. These files are auto-generated and do not require a newline at the end of the file - do not flag missing newlines

  - name: Log Field Standards
    fileFilters:
      - "**/*.rb"
    instructions: |
      Backend engineers should be complying with the new field standardisation in observability best practices
      1. For any log lines that have been altered:
        - Ask: "If you are adding or modifying fields, please ensure that the field is defined within the LabKit Ruby Fields module engineers should follow Field Standardisation Guidelines - https://handbook.gitlab.com/handbook/engineering/architecture/design-documents/observability_field_standardisation/
        - Remind: "Common logging fields should be defined within the LabKit Ruby fields module - https://gitlab.com/gitlab-org/ruby/gems/labkit-ruby/-/blob/master/lib/labkit/fields.rb?ref_type=heads and imported from there."
      2. For any new fields being added to log messages:
        - Check to ensure that these fields are not dynamically generated
        - Remind: "We're aiming to standardise the fields that we emit across all of our services at GitLab through this approach"
