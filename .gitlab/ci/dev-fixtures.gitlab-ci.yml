.run-dev-fixtures:
  extends:
    - .default-retry
    - .ruby-cache
    - .default-before_script
    - .use-pg16-clickhouse23
  stage: test
  needs: ["setup-test-env"]
  variables:
    RAILS_ENV: "test"
    FIXTURE_PATH: "db/fixtures/development"
    SEED_VSA: "true"
    SEED_PRODUCTIVITY_ANALYTICS: "true"
    SEED_CUSTOMIZABLE_CYCLE_ANALYTICS: "true"
    SEED_CI_CD_ANALYTICS: "true"
    SEED_AI_USAGE_STATS: "true"
    SEED_PIPELINE_METRICS: "true"
    VSA_ISSUE_COUNT: 1
    DISABLE_WEBMOCK: "true"
    SIZE: 0  # number of external projects to fork, requires network connection
    # SEED_NESTED_GROUPS: "false"  # requires network connection

.run-dev-fixtures-script: &run-dev-fixtures-script
  - section_start "gitaly-test-spawn" "Spawning Gitaly"; scripts/gitaly-test-spawn; section_end "gitaly-test-spawn";  # Do not use 'bundle exec' here
  - section_start "setup-clickhouse" "Setup ClickHouse"
  - !reference [.clickhouse-setup, script]
  - bundle exec rake gitlab:clickhouse:schema:load
  - section_end "setup-clickhouse"
  - section_start "seeding-db" "Seeding DB";  bundle exec rake db:seed_fu; section_end "seeding-db";
run-dev-fixtures:
  extends:
    - .run-dev-fixtures
    - .dev-fixtures:rules:foss-only
  script:
    - *run-dev-fixtures-script

run-dev-fixtures-ee:
  extends:
    - .run-dev-fixtures
    - .dev-fixtures:rules:ee-only
  services:
    - !reference [.use-pg16-clickhouse23, services]
    - !reference [.es7-services, services]
  script:
    - cp ee/db/fixtures/development/* $FIXTURE_PATH
    - *run-dev-fixtures-script
