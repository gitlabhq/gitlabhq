# Coverage export jobs for both RSpec and Jest test suites

.coverage-export-base:
  extends:
    - .default-retry
    - .ruby-cache
  stage: post-test
  allow_failure: true
  before_script:
    - !reference [.default-utils-before_script, before_script]
    - eval "bundle install ${BUNDLE_INSTALL_FLAGS}"
  variables:
    CLICKHOUSE_URL: $GLCI_CLICKHOUSE_METRICS_URL
    CLICKHOUSE_DATABASE: $GLCI_CLICKHOUSE_TEST_COVERAGE_DB
    CLICKHOUSE_USERNAME: $GLCI_CLICKHOUSE_METRICS_USERNAME
    # Note: GLCI_CLICKHOUSE_METRICS_PASSWORD is read directly from the environment
    # by the test-coverage script and is not passed via CLI for security reasons

test-coverage:export-rspec:
  extends:
    - .coverage-export-base
    - .rails:rules:coverage-export
  needs:
    - job: rspec:coverage
    - job: update-tests-metadata
  script:
    - echo "Exporting RSpec coverage to ClickHouse..."
    - bundle exec test-coverage
        --test-reports 'rspec/rspec-*.json'
        --coverage-report 'coverage/lcov/gitlab.lcov'
        --test-map 'crystalball/packed-mapping.json.gz'
        --clickhouse-url "${CLICKHOUSE_URL}"
        --clickhouse-database "${CLICKHOUSE_DATABASE}"
        --clickhouse-username "${CLICKHOUSE_USERNAME}"

test-coverage:export-jest:
  extends:
    - .coverage-export-base
    - .rails:rules:coverage-export
  needs:
    - job: coverage-frontend
  script:
    - echo "Exporting Jest coverage to ClickHouse..."
    - bundle exec test-coverage
        --test-reports 'jest-reports/**/*.json'
        --coverage-report 'coverage-frontend/lcov.info'
        --test-map 'jest-test-mapping/jest-source-to-test.json'
        --clickhouse-url "${CLICKHOUSE_URL}"
        --clickhouse-database "${CLICKHOUSE_DATABASE}"
        --clickhouse-username "${CLICKHOUSE_USERNAME}"
