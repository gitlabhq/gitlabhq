# Coverage export jobs for both RSpec and Jest test suites

.coverage-export-base:
  extends:
    - .default-retry
    - .ruby-cache
  stage: post-test
  allow_failure: true
  before_script:
    - !reference [.default-utils-before_script, before_script]
    - eval "bundle install ${BUNDLE_INSTALL_FLAGS}"
  variables:
    CLICKHOUSE_URL: $GLCI_DA_CLICKHOUSE_URL
    CLICKHOUSE_DATABASE: $GLCI_CLICKHOUSE_CODE_COVERAGE_DB
    CLICKHOUSE_SHARED_DB: $GLCI_CLICKHOUSE_SHARED_DB
    CLICKHOUSE_USERNAME: $GLCI_CLICKHOUSE_METRICS_USERNAME
    # Note: GLCI_CLICKHOUSE_METRICS_PASSWORD is read directly from the environment
    # by the test-coverage script and is not passed via CLI for security reasons

test-coverage:export-rspec-and-e2e:
  extends:
    - .coverage-export-base
    - .rails:rules:coverage-export-rspec-and-e2e
  stage: post-qa
  needs:
    - job: e2e:test-on-gdk
      optional: true
    - job: rspec:coverage
      optional: true
    - job: update-tests-metadata
      optional: true
  script:
    - ruby scripts/coverage/download_e2e_artifacts_from_child_pipeline.rb
    - ruby scripts/coverage/merge_backend_coverage.rb
    - echo "Merging E2E test mappings with Crystalball mappings..."
    - ruby scripts/coverage/merge_e2e_backend_test_mapping.rb
    - ruby scripts/coverage/backend_coverage_exporter.rb || true
  artifacts:
    paths:
      - coverage-backend/
      - coverage-e2e-backend/
      - coverage/
      - crystalball/
      - rspec/
      - e2e-test-reports/
    expire_in: 7d

test-coverage:export-jest-and-e2e:
  extends:
    - .coverage-export-base
    - .with-ci-node-image
    - .yarn-cache
    - .frontend:rules:coverage-export-jest-and-e2e
  stage: post-qa
  needs:
    - job: e2e:test-on-gdk
      optional: true
    - job: coverage-frontend
      optional: true
  before_script:
    - !reference [.default-utils-before_script, before_script]
    - eval "bundle install ${BUNDLE_INSTALL_FLAGS}"
    - source scripts/utils.sh
    - yarn_install_script
  script:
    - ruby scripts/coverage/download_e2e_artifacts_from_child_pipeline.rb
    - echo "Merging Jest + E2E coverage..."
    - node scripts/frontend/merge_coverage_frontend.js
    - echo "Merging E2E test mappings with Jest mappings..."
    - node scripts/frontend/merge_e2e_frontend_test_mapping.js
    - ruby scripts/coverage/frontend_coverage_exporter.rb || true
  artifacts:
    paths:
      - coverage-frontend/
      - coverage-e2e-frontend/
      - jest-reports/
      - jest-test-mapping/
      - e2e-test-reports/
    expire_in: 7d

test-coverage:export-workhorse:
  extends:
    - .coverage-export-base
    - .workhorse:rules:workhorse-coverage
  needs:
    - job: workhorse-coverage
      optional: true
  script:
    - ruby scripts/coverage/workhorse_coverage_exporter.rb || true
  artifacts:
    paths:
      - workhorse/
      - workhorse-test-reports/
      - workhorse-test-mapping/
    expire_in: 7d

sync-category-owners:
  extends:
    - .default-retry
    - .ruby-cache
    - .rails:rules:sync-category-owners
  stage: post-qa
  needs: []
  before_script:
    - !reference [.default-utils-before_script, before_script]
    - eval "bundle install ${BUNDLE_INSTALL_FLAGS}"
  script:
    - bundle exec sync-category-owners
        --clickhouse-url "${GLCI_DA_CLICKHOUSE_URL}"
        --clickhouse-database "${GLCI_CLICKHOUSE_SHARED_DB}"
        --clickhouse-username "${GLCI_CLICKHOUSE_METRICS_USERNAME}"
