#!/usr/bin/env ruby

require_relative 'ee_specific_check/ee_specific_check'

include EESpecificCheck # rubocop:disable Style/MixinUsage
git_version

base = find_compare_base

current_numstat = updated_diff_numstat(base.ce_merge_base, base.ee_fetch_base)
updated_numstat = updated_diff_numstat(base.ce_updated_base, 'HEAD')

offenses = updated_numstat.select do |file, updated_delta|
  current_delta = current_numstat[file]

  more_lines =
    current_delta &&
    updated_delta > current_delta &&
    WHITELIST.all? { |pattern| !Dir.glob(pattern).include?(file) }

  # Don't complain if we're just adding 1 or 2 more lines, which could be
  # `prepend EE::Module` and a blank line that we want.
  more_lines && !(current_delta == 0 && updated_delta <= 2)
end

if offenses.empty?
  say "ðŸŽ‰ All good, congrats! ðŸŽ‰"
else
  puts

  offenses.each do |(file, delta)|
    puts "* ðŸ’¥ #{file} has #{delta - current_numstat[file]} more different lines than before! ðŸ’¥"
  end

  say <<~MESSAGE
    â„¹ï¸ Consider using an EE module to add the features you want.
    â„¹ï¸ See this for detail: https://docs.gitlab.com/ee/development/ee_features.html#ee-features-based-on-ce-features
  MESSAGE
end

remove_remotes

say "â„¹ï¸ For more information on why, see https://gitlab.com/gitlab-org/gitlab-ee/issues/2952"

exit(offenses.size)
