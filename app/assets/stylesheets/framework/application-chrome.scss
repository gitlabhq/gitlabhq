@use "sass:map";

/*
 * Application chrome
 */

:where(.application-chrome) {

  // Variable overrides
  @include media-breakpoint-up(xl) {
    &.page-with-panels .page-with-super-sidebar {
      --application-bar-left: 0px; // stylelint-disable-line length-zero-no-unit
    }
  }

  // Fix height
  &, body {
    @apply gl-h-full;
  }

  body {
    @apply gl-flex gl-flex-col;
    // Application chrome background
    background-color: var(--super-sidebar-bg);
  }

  // Disable global bootstrap modal backdrop when using panels
  .modal-open:has(.panel-content .modal.show) {
    .modal-backdrop {
      display: none;
    }
  }

  // When using panels, remove top padding
  &.page-with-panels .layout-page {
    @apply gl-pt-0 #{!important};
  }

  // Super topbar
  .super-topbar {
    @apply gl-fixed gl-w-full gl-left-0 gl-shrink-0 gl-py-0 gl-pl-4 gl-pr-5 sm:gl-pr-3;
    top: $calc-system-headers-height;
    height: var(--header-height);

    // Placeholder styles
    .topbar-search-button-placeholder {
      font-weight: 320;
      line-height: 1.25;
      color: var(--gl-control-placeholder-color);
    }
  }

  // Super sidebar
  .super-sidebar-wrapper {
    @apply gl-w-0 gl-h-0 lg:gl-h-auto;
  }

  @media (min-width: $breakpoint-xl) {
    $icon-sidebar-width: 48px;

    .super-sidebar-wrapper {
      width: auto;
    }

    .super-sidebar.super-sidebar-loading {
      position: relative;

      &:not(.super-sidebar-is-icon-only) {
        width: calc(#{$super-sidebar-width} - 8px);
      }

      &.super-sidebar-is-icon-only {
        width: calc(#{$icon-sidebar-width} - 8px);
      }
    }

    .ai-panels {
      min-width: calc(#{$icon-sidebar-width} - 8px);
    }
  }

  .page-with-super-sidebar-collapsed {
    .super-sidebar {
      @apply gl-m-0;
    }
  }

  // Super sidebar active item
  .super-sidebar-nav-item {
    @apply gl-rounded-lg #{!important};
  }

  // Search button
  .gl-dark .super-topbar .topbar-search-button:not(:hover):not(:focus):not(:active) {
    @apply gl-bg-alpha-light-8;
  }

  // Quick search overlay
  #super-sidebar-search-modal {
    @apply gl-pt-0;

    /* stylelint-disable scss/at-rule-no-unknown */
    @media (prefers-reduced-motion: no-preference) {
      transition-property: opacity;
      transition-timing-function: $gl-easing-out-cubic;

      &.show {
        opacity: 1;
        transition-duration: 0.2s;

        .modal-dialog {
          scale: 1;
          transition-duration: 0.2s;
        }
      }

      &:not(.show) {
        opacity: 0;
        transition-duration: 0.1s;

        .modal-dialog {
          scale: 0.8;
          transition-duration: 0.1s;
        }
      }

      @starting-style {
        opacity: 0;
      }

      .modal-dialog {
        transform-origin: top center;
        transform: none !important;
        transition-property: scale;
        transition-timing-function: $gl-easing-out-cubic;

        @starting-style {
          scale: 0.8;
        }
      }
    }
  }


  // Position for search overlay when Performance bar is visible
  &.with-performance-bar #super-sidebar-search-modal {
    padding-top: $performance-bar-height;
  }

  // Quick search overlay search input
  &.page-with-panels .global-search-modal .modal-content {
    @apply gl-rounded-[1rem] #{!important};

    .gl-search-box-by-type-input-borderless {
      @apply gl-rounded-[0.75rem];
    }
  }

  // Organization switcher adjustment (light mode only)
  &:not(.gl-dark) .super-topbar .organization-switcher-button.gl-button:not(:hover):not(:focus):not(:active) {
    @apply gl-bg-alpha-dark-6 gl-border-default;
  }

  .panel-content-inner:has(.issue-boards-content) {
    @apply gl-mx-0;
  }
}

/*
 * Panels
 */

:where(.page-with-panels) {
  --ai-panel-height: 3rem; //= 48px

  @include media-breakpoint-up(lg) {
    --ai-panel-height: 0px; // stylelint-disable-line length-zero-no-unit
  }

  // Layout
  &.page-with-panels .layout-page {
    @apply gl-flex gl-gap-0 lg:gl-gap-3 gl-items-stretch gl-justify-start lg:gl-justify-center gl-flex-col lg:gl-flex-row gl-pl-3 lg:gl-pl-0 gl-pt-3 lg:gl-pb-3 gl-pr-3 gl-h-full;

    @include media-breakpoint-up(lg) {
      height: calc(100% - var(--system-header-height) - var(--performance-bar-height) - var(--header-height) - var(--ai-panel-height));
    }

    // Temporarily solution to hide empty AI Chat divs
    // empty:gl-hidden and :empty doesn't work because these empty divs have comment blocks
    > div:not(:has(*)) {
      @apply gl-hidden;
    }
  }

  // Unset fixed positions
  #js-peek,
  .super-topbar,
  #super-sidebar,
  .header-logged-out {
    @apply gl-relative #{!important};
    @apply gl-top-0;
  }

  // Super sidebar height
  #super-sidebar {
    @apply gl-h-full lg:-gl-mr-3;

    @include media-breakpoint-down(lg) {
      @apply gl-fixed #{!important};
      @apply gl-rounded-r-[1rem];
    }

    .contextual-nav {
      @apply gl-pt-2;
    }
  }

  // Super sidebar scollbar.
  .super-sidebar-inner-scrollbar {
    scrollbar-color: var(--gl-color-neutral-400) transparent;
    scrollbar-width: thin;
  }

  // Panels container
  .panels-container {
    @apply gl-relative gl-grow gl-flex gl-pr-0 gl-pb-0;

    .panel-content-inner,
    .vue-portal-target .work-item-drawer-content {
      height: calc(100% - #{$header-height} - #{$gl-spacing-scale-3});

      @apply gl-overflow-y-auto gl-overflow-x-hidden;
      scrollbar-color: var(--gl-color-neutral-400) transparent;
      scrollbar-width: thin;

      .container-fluid {
        @apply gl-px-4 gl-pb-3;
      }

      // Hide alert wrapper if it's empty
      > .alert-wrapper:not(:has(*)),
      > .alert-wrapper:not(:has(.container-fluid *)) {
        @apply gl-hidden;
      }
    }
  }

  // Static panel
  .paneled-view.static-panel {
    // Specifics here
  }

  // Contextual panel
  .paneled-view.contextual-panel {
    @apply gl-overflow-y-auto gl-flex-1 gl-rounded-lg gl-bg-default empty:gl-hidden gl-h-full;
    @apply gl-z-[252] gl-w-8/10 gl-right-0;
    clip-path: inset(0 0 0 -15px round 1rem);
  }

  // AI panel
  .paneled-view.ai-panels {
    @apply gl-px-0 sm:gl-px-3 lg:gl-px-2 lg:-gl-mx-2;

    .ai-panel-header {
      z-index: $top-bar-z-index;
      @apply gl-sticky #{!important};
      @apply gl-top-0 gl-py-3 gl-px-3;
    }

    .ai-nav-icon-active,
    .ai-nav-icon-active:hover,
    .ai-nav-icon:hover {
      background-color: var(--super-sidebar-nav-item-current-bg);
      color: var(--super-sidebar-accent-color-fg);
    }
  }

  .ai-panel-body{
    max-height: calc(100vh - #{$header-height} - #{$gl-spacing-scale-3} - #{$top-bar-height} - #{$gl-spacing-scale-8});
  }

  .ai-panel-header-actions {
    border-left: 1px solid var(--super-sidebar-bg);
    @apply gl-pl-3;
  }

  .paneled-view:has(.ai-panel-maximized) {
    flex-grow: 1;
  }

  // Hiding all other panels when DAP is maximized
  .panels-container:has(~ .paneled-view .ai-panel-maximized) {
    display: none;
  }

  // Preserving other panels when DAP is maximized on bigger screens
  @media(min-width: #{$paneled-layout-ultra-wide-breakpoint}) {
    .paneled-view:has(.ai-panel-maximized) {
      width: auto;
    }

    .panels-container:has(~ .paneled-view .ai-panel-maximized) {
      display: flex;
    }
  }

  // Panel header
  .panel-header .top-bar-fixed,
  .work-item-drawer-header {
    @apply gl-bg-default gl-shadow-none gl-relative gl-px-5 #{!important};
    z-index: 99;
    border-bottom: 1px solid var(--super-sidebar-bg);
  }

  // Scrollbar offset
  .panel-content-inner,
  .vue-portal-target .work-item-drawer {
    @apply gl-mx-3;
  }

  // Panel content
  .panel-content {
    @apply gl-overflow-clip gl-h-full gl-pb-0;
    contain: strict;
  }

  // Vue portal height
  .vue-portal-target {
    @apply gl-h-full;
  }

  // Work item drawer adjustments
  .work-item-drawer-header {
    @apply -gl-mx-3 gl-py-4;
    width: calc(100% + 1rem) !important;
  }

  // Work item spacing adjustment
  .vue-portal-target .work-item-drawer-content {
    @apply gl-px-5 #{!important};
  }

  // Work item modal footer
  #create-work-item-modal {
    container-type: inline-size;
    container-name: panel;
  }

  // Content adjustments within panels
  .paneled-view {
    @apply gl-overflow-clip;
    @apply gl-rounded-[1rem] #{!important};

    // Work item drawer
    .work-item-drawer {
      @apply gl-h-full gl-pt-0;
    }

    // Issue sticky header
    .issue-sticky-header:not(.merge-request-sticky-header) {
      @apply gl-w-full gl-border-b-subtle;
      top: -1px !important;

      .work-item-sticky-header-text {
        @apply @xl/panel:gl-px-4 gl-py-2;
      }
    }

    .work-item-drawer .issue-sticky-header:not(.merge-request-sticky-header) {
      top: calc(#{$header-height} + 1px) !important;

      .work-item-sticky-header-text {
        @apply gl-px-6;
      }
    }

    // Merge request sticky header wrapper
    .merge-request-sticky-header-wrapper,
    .merge-request-sticky-header::after,
    .issue-sticky-header.merge-request-sticky-header {
      @include media-breakpoint-up(md) {
        top: 0 !important;
      }
    }

    // Legacy merge request sticky header (Firefox)
    .issue-sticky-header.merge-request-sticky-header .issue-sticky-header-text {
      @apply gl-px-6 @xl/panel:gl-px-4;
    }

    // Issue boards height
    .boards-app {
      height: calc(#{$calc-application-viewport-height} - 1.5rem);
    }

    // MR file change header
    .diff-file .file-title, .diff-file .file-title-flex-parent {
      @media (min-width: map-get($grid-breakpoints, md)) {
        top: calc(#{$mr-sticky-header-height} - 2px) !important;

        &.is-wiki {
          top: -1px;
        }
      }
    }

    // MR sidebar
    .work-item-attributes-wrapper,
    .issuable-sidebar.is-merge-request .issuable-context-form {
      @include media-breakpoint-up(lg) {
        top: calc(#{$mr-sticky-header-height} - 1px) !important;
        @apply gl-pr-4 #{!important};
      }
    }

    // Issue sidebar
    @include media-breakpoint-up(md) {
      .work-item-attributes-wrapper {
        top: calc(#{$work-item-sticky-header-height} + #{$gl-spacing-scale-3}) !important;
        height: calc(#{$calc-application-viewport-height} - #{$work-item-sticky-header-height} - #{$gl-spacing-scale-6});
      }
    }

    // Project sidebar
    @include media-breakpoint-up(lg) {
      .project-page-indicator:not(.hidden) + .project-page-layout .project-page-sidebar {
        top: calc(#{$gl-spacing-scale-4}) !important;
      }
    }

    // User profile sidebar
    @include media-breakpoint-up(lg) {
      .user-profile .profile-header {
        top: -1px !important;
      }
    }

    // Sticky headers below top bar
    .right-sidebar,
    .issue-sticky-header:not(.merge-request-sticky-header),
    .settings-sticky-header,
    .rd-diff-file-header-sticky {
      top: -1px !important;
    }

    // Sticky flash alert
    .flash-container:has(.gl-alert) {
      top: auto !important;
    }

    // Sticky settings header
    .settings-sticky-header::after {
      top: 2.5rem !important;
    }

    // Fix drawer height
    .gl-drawer {
      height: calc(100% - #{$header-height});
    }

    // MR: File tree sidebar alignment
    .rd-app-sidebar {
      top: calc(#{$mr-sticky-header-height} + 1rem + -1px) !important;
    }

    // Compare revision: File tree sidebar alignment
    .rd-app .rd-app-sidebar {
      top: calc(1rem + -1px) !important;
    }
  }

  // Sidebar adjustments
  :where(.right-sidebar-expanded) {
    .content-wrapper {
      @apply gl-pr-0 #{!important};
    }

    &:not(.wiki-sidebar):not(.build-sidebar) .panel-content-inner {
      @container content-panels (width >= #{map.get($breakpoints, 'sm')}) {
        padding-right: $right-sidebar-width;
      }
    }
  }

  // Position fixed sidebar fix
  .right-sidebar:not(.right-sidebar-merge-requests):not(.wiki-sidebar):not(.build-sidebar):not(.issuable-bulk-update-sidebar) {
    @apply gl-hidden #{!important};

    &.right-sidebar-expanded {
      @apply gl-block #{!important};
    }

    @container content-panels (width >= #{map.get($breakpoints, 'sm')}) {
      @apply gl-block #{!important};
    }
  }

  .right-sidebar.right-sidebar-collapsed.issues-bulk-update {
    @apply gl-border-l-0;
  }

  :where(.right-sidebar-collapsed:not(.issuable-bulk-update-sidebar)) {
    .content-wrapper {
      @apply gl-pr-0 #{!important};
    }

    .panel-content-inner {
      @container content-panels (width >= #{map.get($breakpoints, 'sm')}) {
        padding-right: $right-sidebar-collapsed-width;
      }
    }
  }

  // Linux scrollbar adjustment
  .gl-platform-linux .panels-container {
    .panel-content-inner,
    .vue-portal-target [data-testid="work-item-detail"] {
      scrollbar-width: auto;
    }
  }

  // Static and Contextual panels
  .paneled-view.static-panel,
  .paneled-view.contextual-panel {
    @apply gl-overflow-clip gl-p-0 gl-rounded-[1rem];
  }

  // AI panel
  .paneled-view.ai-panels .ai-panel {
    @include media-breakpoint-down(md) {
      @apply gl-fixed -gl-mt-2 gl-shadow-lg;
      @apply gl-left-5 #{!important};
      top: var(--header-height);
      width: calc(100% - #{$gl-spacing-scale-5 * 2});
      height: calc(100% - var(--system-header-height) - var(--performance-bar-height) - var(--header-height) - var(--ai-panel-height));
      z-index: 999;
    }
  }

  .content-wrapper.paneled-view {
    @apply gl-pt-0;
  }

  /* Hide all .paneled-view elements when the last .paneled-view contains .fullscreen */
  .panels-container:has(~ .paneled-view .fullscreen) {
    @apply gl-hidden;
  }

  .paneled-view:has(.fullscreen) {
    @apply gl-grow;
  }

}

/*
 * Themes
 */

.application-chrome.page-with-panels {
  // Light mode
  &:not(.gl-dark) {
    // default color to mute the gradient
    --_shade-1: hsla(from var(--theme-color) h 25 95 / 90%);
    // alternative color
    --_shade-2: hsl(from var(--theme-color) calc(h + 60) calc(s + 20) l);
    // original color
    --_shade-3: hsl(from var(--theme-color) h calc(s + 20) l);
    // bottom color
    --_shade-4: hsla(from var(--theme-color) calc(h + 30) calc(s + 20) l / 40%);

    // Temporarily unship this change as it introduced some regressions, see https://gitlab.com/gitlab-org/gitlab/-/merge_requests/204009
    // --theme-background-color: color-mix(in srgb, var(--gl-background-color-default), var(--theme-color) 2%);
    --theme-background-color: var(--gl-background-color-default);
    --theme-border-color: hsl(from var(--theme-color) h 24 90);

    body {
      background:
        linear-gradient(var(--_shade-1), var(--_shade-1)),
        radial-gradient(farthest-side at 50% 0%, var(--_shade-3), transparent 50vw),
        radial-gradient(farthest-side at 50% 0%, var(--_shade-2), transparent 70vw),
        linear-gradient(-10deg, var(--_shade-4), transparent 70%),
        var(--gl-background-color-default);
    }

    .ai-panels,
    .super-sidebar,
    .super-topbar {
      --super-sidebar-bg: var(--theme-background-color);
      --super-sidebar-accent-color-fg: hsl(from var(--theme-accent-color) h calc(s - 20) 20);
      --super-sidebar-nav-item-current-bg: hsla(from var(--theme-accent-color) h s l / 16%);
      --super-sidebar-nav-item-hover-bg: hsla(from var(--theme-accent-color) h s l / 16%);
      --super-sidebar-accent-color-badge: hsl(from var(--theme-accent-color) h s 90);
      --super-sidebar-user-bar-notification-dot: hsl(from var(--theme-notification-color) calc(h - 2) s calc(l + 2));
      --super-sidebar-accent-color-bg: hsla(from var(--theme-accent-color) h s l / 16%);
    }

    .super-sidebar hr {
      border-color: var(--gl-color-alpha-dark-8);
    }

    .super-sidebar .super-sidebar-nav-item.super-sidebar-nav-item-current:not(:hover) .badge {
      background-color: var(--_shade-1);
    }

    .ai-panel .ai-nav-icon-active,
    .ai-panel .ai-nav-icon-active:hover,
    .ai-panel .ai-nav-icon:hover {
      background-color: var(--super-sidebar-nav-item-current-bg);
    }

    .ai-panel .ai-nav-icon-active {
      color: var(--super-sidebar-accent-color-fg);
    }
  }

  // Dark mode
  &.gl-dark {
    // default color to mute the gradient
    --_shade-1: hsla(from var(--gl-background-color-default) h s l / 75%);
    // background
    --_shade-2: hsl(from var(--theme-color) h 15 20);
    // alternative color
    --_shade-3: hsla(from var(--theme-color) calc(h + 30) s l / 70%);
    // original color
    --_shade-4: hsla(from var(--theme-color) h s l / 100%);
    // bottom color
    --_shade-5: hsla(from var(--theme-color) h s l / 55%);

    // Temporarily unship this change as it introduced some regressions, see https://gitlab.com/gitlab-org/gitlab/-/merge_requests/204009
    // --theme-background-color: color-mix(in srgb, var(--gl-background-color-default), var(--theme-color) 1%);
    --theme-background-color: var(--gl-background-color-default);
    --theme-border-color: hsl(from var(--theme-color) h 12 25);

    body {
      background:
        linear-gradient(var(--_shade-1), var(--_shade-1)),
        radial-gradient(farthest-side at 50% 0%, var(--_shade-4), transparent 50vw),
        radial-gradient(farthest-side at 50% 0%, var(--_shade-3), transparent 65vw),
        linear-gradient(-10deg, var(--_shade-5), transparent),
        var(--_shade-2);
    }

    .ai-panels,
    .super-sidebar,
    .super-topbar {
      --super-sidebar-bg: var(--theme-background-color);
      --super-sidebar-nav-item-current-bg: hsla(from var(--theme-accent-color) h s calc(l + 20) / 25%);
      --super-sidebar-accent-color-fg: hsl(from var(--theme-accent-color) h s 88);
      --super-sidebar-nav-item-hover-bg: hsla(from var(--theme-accent-color) h calc(s - 30) l / 16%);
      --super-sidebar-accent-color-badge: hsl(from var(--theme-accent-color) h s 85);
      --super-sidebar-user-bar-notification-dot: hsl(from var(--theme-notification-color) calc(h - 2) s calc(l + 20));
      --super-sidebar-accent-color-bg: hsla(from var(--theme-accent-color) h s l / 32%);
    }

    .super-sidebar hr {
      border-color: var(--gl-color-alpha-light-16);
    }

    .super-sidebar .super-sidebar-nav-item.super-sidebar-nav-item-current:not(:hover) .badge {
      color: var(--super-sidebar-accent-color-fg);
      background-color: var(--_shade-1);
    }

    .ai-panel .ai-nav-icon-active,
    .ai-panel .ai-nav-icon-active:hover,
    .ai-panel .ai-nav-icon:hover {
      color: var(--super-sidebar-accent-color-fg);
      background-color: var(--super-sidebar-nav-item-current-bg);
    }
  }

  .super-topbar,
  .super-sidebar:not(.super-sidebar-is-mobile),
  .super-sidebar .bottom-scrim,
  .super-sidebar .top-scrim {
    background: transparent !important;
  }

  .bottom-scrim-visible,
  .top-scrim-visible {
    border-color: var(--theme-border-color);
  }

  .panel-header .top-bar-fixed,
  .work-item-drawer-header,
  .ai-panel-header {
    border-bottom: 1px solid var(--theme-border-color);
  }

  .top-bar-fixed,
  .static-panel,
  .contextual-panel,
  .ai-panel,
  .settings-sticky-header,
  .settings-sticky-header::before,
  .settings-sticky-footer {
    background-color: var(--theme-background-color) !important;
  }
}

/*
 * Animations
 */

:where(.application-chrome) {
  .nav-flyout-menu {
    @include gl-prefers-reduced-motion-transition;
    transition: opacity .2s .1s $gl-easing-out-cubic;

    @starting-style {
      opacity: 0;
    }
  }

  @media (prefers-reduced-motion: no-preference) {
    .super-sidebar-nav-item {
      transition-duration: .2s;
      transition-timing-function: $gl-easing-out-cubic;
      transition-property: color, background-color;
    }

    .super-sidebar-animatable {
      .nav-item-link-label,
      .menu-section-button-label {
        transition-duration: .15s;
        transition-timing-function: $gl-easing-out-cubic;
        transition-property: opacity, translate;

        @starting-style {
          opacity: 0;
          translate: -30% 0;
        }
      }

      .super-sidebar-context-header {
        transition-duration: .15s;
        transition-timing-function: $gl-easing-out-cubic;
        transition-property: opacity, translate;

        @starting-style {
          opacity: 0;
          translate: 0 -30%;
        }
      }

      .nav-item-link-badge {
        transition-duration: .15s;
        transition-timing-function: $gl-easing-out-cubic;
        transition-property: opacity;

        @starting-style {
          opacity: 0;
        }
      }
    }
  }

  @supports (width: calc-size(auto, size)) {
    .super-sidebar,
    .panels-container {
      width: calc-size(auto, size);
      /* stylelint-disable-next-line property-no-unknown */
      interpolate-size: allow-keywords;
      transition: width .25s $gl-easing-out-cubic !important;
    }
  }
}
