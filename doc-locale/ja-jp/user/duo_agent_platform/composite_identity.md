---
stage: AI-powered
group: Agent Foundations
info: To determine the technical writer assigned to the Stage/Group associated with this page, see https://handbook.gitlab.com/handbook/product/ux/technical-writing/#assignments
title: 複合アイデンティティ
---

{{< details >}}

- プラン: Ultimate
- アドオン: GitLab Duo Core、Pro、またはEnterprise
- 提供形態: GitLab.com、GitLab Self-Managed、GitLab Dedicated

{{< /details >}}

{{< history >}}

- GitLab 18.3で`duo_workflow_use_composite_identity`[フラグ](../../administration/feature_flags/_index.md)とともに[導入](https://gitlab.com/gitlab-org/gitlab/-/issues/554156)されました。
- GitLab 18.8で[一般提供](https://gitlab.com/gitlab-org/gitlab/-/work_items/585273)になりました。

{{< /history >}}

{{< alert type="flag" >}}

この機能の利用可否は、機能フラグによって制御されます。詳細については、履歴を参照してください。

{{< /alert >}}

コンポジットIDとは、2つのIDを1つのトークンに結合する認証および認可メカニズムです:

- サービスアカウント。実際のアクションを実行するマシンユーザー。
- 人間のユーザー。リクエストを開始した人。

この二重IDアプローチは、重大な課題を解決します。エージェントは、エージェントをトリガーしたユーザーのアクセス権、またはサービスアカウントに付与されたアクセス権を超えない範囲でアクションを実行する必要があり、同時に、アクションが人間のユーザーによって直接ではなく、エージェントによって実行されたことを明確に示すために、明確なIDを維持する必要があります。

## コンポジットIDが重要な理由 {#why-composite-identity-matters}

コンポジットIDが重要なのは、以下のことを保証するのに役立つためです:

- 追跡可能性: すべてのエージェントのアクティビティーはサービスアカウントに明確に帰属するため、監査ログとコミット履歴で自動化されたアクションを簡単に識別できます。
- セキュリティ: エージェントは、サービスアカウントとトリガーユーザーのみがアクセスできるアクションを実行できます。この交差的なアクセスにより、特権エスカレーションが防止されます。
- アカウンタビリティ: 人間のユーザーのIDはトークンに埋め込まれ、エージェントのアクションをそれらをトリガーした人に結び付ける監査証跡を作成します。

たとえば、エージェントにコードのテストの作成を依頼すると、結果として得られるコミットは、サービスアカウントによってユーザーに代わって作成されたことを示します。

## コンポジットIDの使用場所 {#where-composite-identity-is-used}

コンポジットIDは、ワークフローとエージェントがRunnerで実行される場合に使用されます。このリストには以下が含まれます:

- Foundationalワークフロー。
- カスタムワークフロー。
- 外部エージェント。
- エンドポイント`api/v4/ai/duo_workflows/workflows`を介して開始されたすべてのワークフロー。

コンポジットIDは、UIおよびIDEのGitLab Duo Chat（エージェント）には適用されません。

## コンポジットIDの仕組み {#how-composite-identity-works}

リクエストを認証するトークンは、次の2つのアイデンティティを組み合わせたものです:

- プライマリオ作成者: トークンのオーナーであり、デベロッパーロールを持つ[サービスアカウント](../profile/service_accounts.md)。
- セカンダリ作成者: エージェントまたはワークフローを開始した人間のユーザー。人間のユーザーの`id`IDは、[動的スコープ](https://github.com/doorkeeper-gem/doorkeeper/pull/1739)を使用してトークンのスコープに含まれています。

このコンポジットIDにより、GitLab Duo Agent Platformによって作成されたすべてのアクティビティーは、サービスアカウントに正しく帰属され、人間のユーザーまたはサービスアカウントによる[特権エスカレーション](https://en.wikipedia.org/wiki/Privilege_escalation)を防止できます。

## コンポジットIDワークフロー {#composite-identity-workflow}

コンポジットIDはワークフローの一部です。

1. AIカタログでワークフローを作成します。
   - コンポジットIDに関連する変更は発生しません。
1. トップレベルグループのワークフローを有効にします。
   - 有効にするには、オーナーである必要があります。
   - サービスアカウントがトップレベルグループに作成されます。（名前は`ai-flowname-groupname`に似ています）。
1. プロジェクトのワークフローを有効にします。
   - ワークフローは、トップレベルグループで有効になっている必要があります。
   - プロジェクトで有効にするには、メンテナーである必要があります。
   - サービスアカウントがデベロッパーロールでプロジェクトに追加されます。
1. ユーザーがワークフローを実行します。
   - ワークフローは、1回限りのコンポジットIDによって実行されます。このIDには、ユーザーのロールとサービスアカウントのデベロッパーロールの組み合わせがあり、どちらか制限の厳しい方が使用されます。そのため、ユーザーがメンテナーであっても、サービスアカウントがデベロッパーである場合は、デベロッパーロールが使用されます。
   - ワークフローは、次の両方のプロジェクトにアクセスできます:
     - ユーザーがアクセスできる。
     - サービスアカウントが追加された。

     たとえば、サービスアカウントが他のプロジェクトに追加され、ユーザーがそれらのプロジェクトにアクセスできる場合、ユーザーが以前にそこでワークフローを使用したことがなくても、ワークフローはそれらのプロジェクトにアクセスできます。

## AIカタログワークフローのトークン権限 {#token-permissions-for-ai-catalog-flows}

AIカタログワークフローは、異なる権限スコープを持つ異なるトークンタイプを使用します:

- AIワークフローでコンポジットIDに使用されるOAuthトークンは、`ai_workflows`および`mcp`スコープへのアクセスが制限されています。このOAuthトークンは、AIゲートウェイに渡されてワークフローを実行します。
- ワークフローの一部としてトリガーされるCIジョブトークンは、[利用可能なジョブトークン権限](../../ci/jobs/ci_job_token.md#job-token-access)によって権限がさらに制限されます。

これらは異なるスコープを持つ異なるトークンタイプであるため、CI/CDジョブにはOAuthトークンとは異なる権限があります。

## マージリクエストのコンプライアンスに関する考慮事項 {#compliance-considerations-for-merge-requests}

ワークフローがマージリクエストを作成すると、マージリクエストは、ワークフローをトリガーした人間のユーザーではなく、サービスアカウントに帰属します。この帰属モデルは、以下を含む、職務分掌を必要とするコンプライアンスフレームワークと矛盾する可能性があります:

- SOC 2（システムおよび組織管理2）
- SOX（サーベンスオクスリー法）
- ISO 27001（情報セキュリティ管理）
- FedRAMP（米国連邦情報セキュリティ管理プログラム）

これらのコンプライアンスフレームワークでは通常、ユーザーがコードの変更を作成し、本番環境へのデプロイのためにそれらの変更を承認できないことが必要です。

### 帰属モデルについて {#understanding-the-attribution-model}

サービスアカウントがコミットを作成してマージリクエストを開いたとしても、人間のユーザーが作成者と見なされる理由は次のとおりです:

- 人間のユーザーがサービスアカウントに変更の作成を指示した。
- コンプライアンスの観点からは、AIシステムにコードの作成をプロンプトすることは、自分でコードを記述することと同じです。
- サービスアカウントは、人間のユーザーの意図のプロキシとして機能します。

コンプライアンス要件の対象となる組織は、マージリクエストを作成する[Foundationalワークフローをオフにする](../gitlab_duo/turn_on_off.md#turn-gitlab-duo-on-or-off)必要があります。
