# frozen_string_literal: true

require 'spec_helper'

RSpec.describe Security::VulnerabilityUUID, feature_category: :vulnerability_management do
  describe '.generate' do
    let(:report_type) { 'sast' }
    let(:primary_identifier_fingerprint) { 'abc123' }
    let(:location_fingerprint) { 'def456' }
    let(:project_id) { 1 }

    it 'generates a UUID v5' do
      uuid = described_class.generate(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id
      )

      expect(uuid).to match(/\A[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\z/)
    end

    it 'generates consistent UUIDs for the same inputs' do
      uuid1 = described_class.generate(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id
      )

      uuid2 = described_class.generate(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id
      )

      expect(uuid1).to eq(uuid2)
    end

    it 'generates different UUIDs for different inputs' do
      uuid1 = described_class.generate(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id
      )

      uuid2 = described_class.generate(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: 2
      )

      expect(uuid1).not_to eq(uuid2)
    end
  end

  describe '.generate_v2' do
    let(:report_type) { 'sast' }
    let(:primary_identifier_fingerprint) { 'abc123' }
    let(:location_fingerprint) { 'def456' }
    let(:project_id) { 1 }
    let(:context_id) { 100 }

    it 'generates a UUID v5' do
      uuid = described_class.generate_v2(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id,
        context_id: context_id
      )

      expect(uuid).to match(/\A[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\z/)
    end

    it 'generates consistent UUIDs for the same inputs' do
      uuid1 = described_class.generate_v2(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id,
        context_id: context_id
      )

      uuid2 = described_class.generate_v2(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id,
        context_id: context_id
      )

      expect(uuid1).to eq(uuid2)
    end

    it 'generates different UUIDs for different context_ids' do
      uuid1 = described_class.generate_v2(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id,
        context_id: context_id
      )

      uuid2 = described_class.generate_v2(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id,
        context_id: 200
      )

      expect(uuid1).not_to eq(uuid2)
    end

    it 'generates different UUIDs than generate without context' do
      uuid_v1 = described_class.generate(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id
      )

      uuid_v2 = described_class.generate_v2(
        report_type: report_type,
        primary_identifier_fingerprint: primary_identifier_fingerprint,
        location_fingerprint: location_fingerprint,
        project_id: project_id,
        context_id: context_id
      )

      expect(uuid_v1).not_to eq(uuid_v2)
    end

    context 'when context_id is nil' do
      it 'still generates a valid UUID' do
        uuid = described_class.generate_v2(
          report_type: report_type,
          primary_identifier_fingerprint: primary_identifier_fingerprint,
          location_fingerprint: location_fingerprint,
          project_id: project_id,
          context_id: nil
        )

        expect(uuid).to match(/\A[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\z/)
      end

      it 'generates different UUIDs than with a context_id' do
        uuid_without_context = described_class.generate_v2(
          report_type: report_type,
          primary_identifier_fingerprint: primary_identifier_fingerprint,
          location_fingerprint: location_fingerprint,
          project_id: project_id,
          context_id: nil
        )

        uuid_with_context = described_class.generate_v2(
          report_type: report_type,
          primary_identifier_fingerprint: primary_identifier_fingerprint,
          location_fingerprint: location_fingerprint,
          project_id: project_id,
          context_id: context_id
        )

        expect(uuid_without_context).not_to eq(uuid_with_context)
      end
    end
  end
end
