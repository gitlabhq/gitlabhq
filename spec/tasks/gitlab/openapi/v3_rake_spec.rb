# frozen_string_literal: true

require 'fast_spec_helper'
require_relative '../../../support/silence_stdout'

RSpec.describe 'gitlab:openapi:v3 namespace rake tasks', :silence_stdout, feature_category: :api do
  before :all do
    Rake.application.rake_require 'tasks/gitlab/openapi/v3'
    Rake::Task.define_task(:environment)
    Rake::Task.define_task(:enable_feature_flags)
  end

  # Stub API and Grape constants before loading the rake tasks
  # to prevent loading files that require the full Rails environment
  before do
    stub_const('Grape::API::Instance', Class.new)
    stub_const('API::Base', Class.new)
    stub_const('Grape::Entity', Class.new)
  end

  let(:yaml_v3_doc_introduction) do
    <<~INTRO
    #############################################################################################
    # This documentation is auto-generated by a script.                                         #
    # Please do not edit this file directly.                                                    #
    #                                                                                           #
    # To edit the introductory text, modify `lib/tasks/gitlab/openapi/v3.rake`.                 #
    #                                                                                           #
    # Run `bin/rake gitlab:openapi:v3:generate`                                                 #
    #############################################################################################

    INTRO
  end

  shared_context 'with openapi v3 generator setup' do
    let(:generator) { instance_double(Gitlab::GrapeOpenapi::Generator) }
    let(:generated_spec) { { 'openapi' => '3.0.0', 'info' => { 'title' => 'GitLab API' } } }
    let(:yaml_content) { "---\nopenapi: 3.0.0\ninfo:\n  title: GitLab API\n" }
    let(:api_descendants) { [Class.new, Class.new, Class.new] }
    let(:entity_descendants) { [Class.new, Class.new, Class.new] }

    before do
      stub_const('Gitlab::GrapeOpenapi::Generator', Class.new)

      allow(API::Base).to receive(:descendants).and_return(api_descendants)
      allow(Grape::Entity).to receive(:descendants).and_return(entity_descendants)
      allow(Gitlab::GrapeOpenapi::Generator).to receive(:new).and_return(generator)
      allow(generator).to receive(:generate).and_return(generated_spec)
    end
  end

  shared_examples_for 'gitlab:openapi:v3:validate' do
    let(:expected_yarn_command) { 'yarn swagger:validate doc/api/openapi/openapi_v3.yaml' }

    context 'when in development environment' do
      before do
        allow(Rails).to receive_message_chain(:env, :development?).and_return(true)
      end

      it 'validates the OpenAPI documentation' do
        expect(main_object).to receive(:system).with(expected_yarn_command).and_return(true)
        run_rake_task('gitlab:openapi:v3:validate')
      end

      context 'when the validation succeeds' do
        it 'completes successfully' do
          allow(main_object).to receive(:system).with(expected_yarn_command).and_return(true)
          expect { run_rake_task('gitlab:openapi:v3:validate') }.not_to raise_error
        end
      end

      context 'when the validation fails' do
        before do
          allow(main_object).to receive(:system).with(expected_yarn_command).and_return(false)
        end

        it 'aborts with the expected error message' do
          expect { run_rake_task('gitlab:openapi:v3:validate') }
            .to raise_error(SystemExit).and output(/Validation of swagger document failed/).to_stderr
        end
      end
    end

    context 'when not in development environment' do
      before do
        allow(Rails).to receive_message_chain(:env, :development?).and_return(false)
      end

      it 'raises the expected RuntimeError error' do
        expect { run_rake_task('gitlab:openapi:v3:validate') }
          .to raise_error(RuntimeError, 'This task can only be run in the development environment')
      end
    end
  end

  shared_examples_for 'gitlab:openapi:v3:generate' do
    include_context 'with openapi v3 generator setup'

    it 'generates the OpenAPI v3 documentation' do
      expect(Gitlab::GrapeOpenapi::Generator).to receive(:new).with(
        api_classes: api_descendants,
        entity_classes: entity_descendants
      ).and_return(generator)

      expect(generator).to receive(:generate).and_return(generated_spec)
      expect(File).to receive(:write).with('doc/api/openapi/openapi_v3.yaml', yaml_v3_doc_introduction + yaml_content)

      run_rake_task('gitlab:openapi:v3:generate')
    end

    context 'when not on test or development environments' do
      let(:expected_error_message) { 'This task can only be run in the development or test environment' }

      before do
        allow(Rails).to receive_message_chain(:env, :test?).and_return(false)
        allow(Rails).to receive_message_chain(:env, :development?).and_return(false)
      end

      it 'raises an error' do
        expect { run_rake_task('gitlab:openapi:v3:generate') }.to raise_error(RuntimeError, expected_error_message)
      end
    end
  end

  describe 'gitlab:openapi:v3:validate' do
    it_behaves_like 'gitlab:openapi:v3:validate'
  end

  describe 'gitlab:openapi:v3:generate' do
    it_behaves_like 'gitlab:openapi:v3:generate'
  end

  describe 'gitlab:openapi:v3:generate_and_check' do
    it_behaves_like 'gitlab:openapi:v3:validate'
    it_behaves_like 'gitlab:openapi:v3:generate'
  end

  describe 'gitlab:openapi:v3:check_docs' do
    include_context 'with openapi v3 generator setup'

    before do
      allow(File).to receive(:read).and_call_original
      allow(File).to receive(:read).with('doc/api/openapi/openapi_v3.yaml')
        .and_return(yaml_v3_doc_introduction + yaml_content)
    end

    it 'passes when documentation is up to date' do
      expect { run_rake_task('gitlab:openapi:v3:check_docs') }.to output(
        /OpenAPI v3 documentation is up to date/).to_stdout
    end

    context 'when documentation is outdated' do
      let(:outdated_yaml) { "---\nopenapi: 3.0.0\ninfo:\n  title: Outdated API\n" }

      before do
        allow(File).to receive(:read).with('doc/api/openapi/openapi_v3.yaml')
          .and_return(yaml_v3_doc_introduction + outdated_yaml)
      end

      it 'aborts with correct message when documentation is outdated' do
        expect { run_rake_task('gitlab:openapi:v3:check_docs') }.to output(
          %r{OpenAPI documentation is outdated! Please update it by running `bin/rake gitlab:openapi:v3:generate`}
        ).to_stdout.and raise_error(SystemExit)
      end
    end

    context "when debug is enabled" do
      let(:outdated_yaml) { "---\nopenapi: 3.0.0\ninfo:\n  title: Outdated API\n" }
      let(:verbose) { Rake::FileUtilsExt.verbose }
      let(:nowrite) { Rake::FileUtilsExt.nowrite }
      let(:expected_command) { "diff -u doc/api/openapi/openapi_v3.yaml doc/api/openapi/openapi_v3.yaml.generated" }

      before do
        stub_env("OPENAPI_CHECK_DEBUG", "true")

        allow(File).to receive(:read).with("doc/api/openapi/openapi_v3.yaml")
          .and_return(yaml_v3_doc_introduction + outdated_yaml)
        allow(File).to receive(:write).with("doc/api/openapi/openapi_v3.yaml.generated", anything)
      end

      it "writes the yaml content to the expected file and outputs the diff with it" do
        expect(File).to receive(:write).with("doc/api/openapi/openapi_v3.yaml.generated", anything)
        expect(main_object).to receive(:sh).with(expected_command)
        expect { run_rake_task("gitlab:openapi:v3:check_docs") }.to raise_error(SystemExit)
      end
    end
  end
end
