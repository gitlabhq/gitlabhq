# The template generates jobs for gems vendored in the main GitLab project
# under `gem_path_prefix` (defaults to `gems/`).
#
# Inputs
# - `gem_name`: The name of the gem, i.e. if the gem is located at `gems/gitlab-rspec`, `gem_name` should be set to `gitlab-rspec`.
# - `gem_path_prefix`: The prefix of the gem path, i.e. if the gem is located at `vendor/gems/gitlab-rspec`, `gem_path_prefix` should be set to `vendor/gems/`. Defaults to `gems/`.
# - `skip_gem_validation`: Whether a validation should be performed.. Defaults to `false`.
spec:
  inputs:
    gem_name:
    gem_path_prefix:
      default: "gems/"
    skip_gem_validation:
      type: boolean
      default: false
---
workflow:
  name: '[$[[inputs.gem_name]] gem] Ruby $RUBY_VERSION pipeline'
  rules:
    - when: always

variables:
  BUNDLE_PATH: "vendor"
  BUNDLE_FROZEN: "true"
  # Download repo from artifacts. See .repo-from-artifacts
  GIT_STRATEGY: "${CI_FETCH_REPO_GIT_STRATEGY}"
  # Default Ruby version for jobs that don't use .ruby_matrix
  RUBY_VERSION: "${RUBY_VERSION_DEFAULT}"
  # Variables for test execution metrics export to ClickHouse
  GLCI_TEST_METRICS_RUN_TYPE: "$[[ inputs.gem_name ]]-tests"
  GLCI_EXPORT_TEST_METRICS: "true"

include:
  - local: .gitlab/ci/version.yml

default:
  tags:
    - gitlab-org
  image: ${GITLAB_DEPENDENCY_PROXY_ADDRESS}ruby:${RUBY_VERSION}
  cache:
    key: "$[[inputs.gem_name]]-${RUBY_VERSION}"
    paths:
      - "$[[inputs.gem_path_prefix]]$[[inputs.gem_name]]/vendor/ruby"
  before_script:
    - cp config/{database.yml.postgresql,database.yml}
    - "sed -i 's/username: postgres$/username: gitlab/g' config/database.yml"
    - "sed -i 's/password:\\s*$/password: password/g' config/database.yml"
    - "sed -i 's/host: localhost$/host: postgres/g' config/database.yml"
    - cd $[[inputs.gem_path_prefix]]$[[inputs.gem_name]]
    - ruby -v                                   # Print out ruby version for debugging
    - bundle_version=$(grep -A 1 "BUNDLED WITH" Gemfile.lock | tail -n 1 | sed -e 's/[[:space:]]//')
    - gem install bundler --version "$bundle_version" --no-document # Bundler is not installed with the image
    - bundle config                             # Show bundler configuration
    - bundle install --jobs=$(nproc) --retry=3
  after_script:
    - source $CI_PROJECT_DIR/scripts/utils.sh

.repo-from-artifacts:
  needs:
    - pipeline: $PARENT_PIPELINE_ID
      job: clone-gitlab-repo

.ruby_matrix:
  extends: .repo-from-artifacts
  parallel:
    matrix:
      - RUBY_VERSION: ["${RUBY_VERSION_DEFAULT}", "${RUBY_VERSION_NEXT}"]

.ruby_and_postgres_matrix:
  extends: .repo-from-artifacts
  services:
    - name: postgres:${POSTGRES_VERSION}
      command: ["postgres", "-c", "fsync=off", "-c", "synchronous_commit=off", "-c", "full_page_writes=off"]
  parallel:
    matrix:
      - RUBY_VERSION: ["${RUBY_VERSION_DEFAULT}", "${RUBY_VERSION_NEXT}"]
        POSTGRES_VERSION: ["14", "15", "16"]

validate-gem:
  extends: .repo-from-artifacts
  rules:
    - if: "'$[[inputs.skip_gem_validation]]' == 'true'"
      when: never
    # Validate all gems stored in `gems/`.
    - if: "'$[[inputs.gem_path_prefix]]' == 'gems/'"
  script:
    - $CI_PROJECT_DIR/scripts/validate-monorepo-gem "$[[inputs.gem_name]]"

validate-gemfile-lock:
  extends: .ruby_matrix
  rules:
    # Validate all Gemfile.lock stored in `gems/`.
    - if: "'$[[inputs.gem_path_prefix]]' == 'gems/'"
      exists: ["$[[inputs.gem_path_prefix]]$[[inputs.gem_name]]/Gemfile.lock"]
  script:
    - bundle lock --add-checksums

rubocop:
  extends: .ruby_matrix
  rules:
    - exists: ["$[[inputs.gem_path_prefix]]$[[inputs.gem_name]]/.rubocop.yml"]
  script:
    - bundle exec rubocop

rspec:
  extends:
    - .ruby_and_postgres_matrix
  variables:
    POSTGRES_USER: gitlab
    POSTGRES_PASSWORD: password
  script:
    - RAILS_ENV=test bundle exec rspec
  coverage: '/LOC \((\d+\.\d+%)\) covered.$/'
  artifacts:
    expire_in: 31d
    when: always
    paths:
      - coverage/
